<!DOCTYPE html><html lang="en"> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.16.0"><!-- Canonical URL --><link rel="canonical" href="https://blog.carlos8v.dev/blog/servir-websockets-com-nginx/"><!-- Primary Meta Tags --><title>Servir websockets com nginx</title><meta name="title" content="Servir websockets com nginx"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://blog.carlos8v.dev/blog/servir-websockets-com-nginx/"><meta property="og:title" content="Servir websockets com nginx"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://blog.carlos8v.dev/blog/servir-websockets-com-nginx/"><meta property="twitter:title" content="Servir websockets com nginx"><style>@import"https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap";:root{--text-primary: white;--text-secondary: #c8c8c8;--text-gray: #323542;--link-color: white;--primary: #3B49DF;--bg-primary: #15161b;--bg-secondary: #1e1f26;--border: #383b3e}*::-webkit-scrollbar{width:6px;height:6px}*::-webkit-scrollbar-thumb{background-color:#323542}*::-webkit-scrollbar-track{box-shadow:inset 0 0 6px #00000026}*{box-sizing:border-box;scroll-behavior:smooth;scroll-margin:70px 0 70px 0}html{font-size:16px}body{background:var(--bg-primary);font-family:Roboto,Arial,Helvetica,sans-serif;color:var(--text-primary);margin:0;padding:0;line-height:1.5rem}a{color:var(--link-color);text-decoration:none}a:hover{text-decoration:underline}hr{border:0;height:1px;background:var(--border);margin:30px 0}p{color:var(--text-secondary)}blockquote{margin:0;color:#6a737d;padding:0 16px;border-left:4px solid var(--text-secondary)}table{width:100%;border-collapse:collapse}table td,table th{padding:10px;border:1px solid var(--border)}table tr:nth-child(2n){background:var(--bg-secondary)}.main-wrapper{margin-top:60px;display:flex;padding:15px 30px;gap:15px 30px}.post-tag{display:inline-block;padding:5px;margin:5px 0;border-radius:4px;color:#fff;background:var(--text-gray);text-decoration:none}.main-footer{margin-top:30px;background:var(--text-primary);color:var(--text-secondary);border-bottom:4px solid var(--primary);display:flex;align-items:center;justify-content:center}@media (max-width: 600px){table{overflow:hidden;overflow-x:scroll;display:block;white-space:nowrap}.main-wrapper{padding:10px}}.main-header{position:fixed;top:0;width:100%;background:var(--bg-primary);border-bottom:1px solid var(--border);padding:10px}.main-header>nav{margin:0 auto;width:100%;max-width:1080px;display:flex;align-items:center;justify-content:space-between}.nav-list{display:none}.nav-link,.nav-link-mobile{font-size:.9rem;display:inline-block;color:#fff}.nav-link+.nav-link{margin-left:15px}.nav-mobile{position:absolute;top:18px;right:15px;width:24px;height:24px;fill:#fff;cursor:pointer}.nav-mobile path{transition:all .25s ease-out}.nav-mobile-active .nav-icon-top{transform:rotate(45deg) translateY(45%);transform-origin:center}.nav-mobile-active .nav-icon-middle{transform:translate(-2rem)}.nav-mobile-active .nav-icon-bottom{transform:rotate(-45deg) translateY(-45%);transform-origin:center}.nav-list-mobile{position:absolute;top:60px;overflow:hidden;background:var(--bg-secondary);left:0;width:100%;display:flex;flex-direction:column}:not(.nav-mobile-active)+.nav-list-mobile{height:0;opacity:0;transition:height .3s ease-in-out,opacity .15s ease-in}:is(.nav-mobile-active)+.nav-list-mobile{opacity:1;height:100vh;transition:height .3s ease-in-out,opacity .25s ease-in}.nav-link-mobile{padding:15px;border-bottom:1px solid var(--border)}@media (min-width: 600px){.main-header{padding:10px 30px}.nav-mobile{display:none}.nav-list{display:block}}
.post-container{width:100%;max-width:1080px;margin:0 auto}.post-content img{max-width:100%}.post-cover{width:100%;max-height:300px;object-fit:cover;object-position:center}.post-cover .top{object-position:top}.post-cover .center{object-position:center}.post-cover .bottom{object-position:bottom}.author-container{display:flex;align-items:center;gap:10px;margin-bottom:20px}.author-container>img{max-width:38px;border-radius:50%}.post-title{font-size:1.75rem;line-height:2rem;font-weight:500}.post-title>small{display:block;font-size:.9rem;color:var(--text-secondary);font-weight:400}@media (min-width: 600px){.post-cover{margin-top:15px}}:root{--comment: #6272a4;--default: #f8f8f2;--cyan: #8BE9FD;--green: #50FA7B;--orange: #FFB86C;--pink: #FF79C6;--purple: #BD93F9;--red: #FF5555;--yellow: #F1FA8C}code,pre{font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace}code[class*=language-],pre[class*=language-]{color:var(--default);background:none;text-shadow:0 1px rgba(0,0,0,.3);text-align:left;padding:0;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-],pre{padding:1em;margin:.5em 0;overflow:auto;border-radius:.3em;background:#1b1f230d}:not(pre)>code[class*=language-],pre[class*=language-]{background:#282a36}:not(pre)>code{padding:0 6px;font-size:.9rem;display:inline-block;border-radius:4px;background:#323542}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.comment,.token.prolog,.token.doctype,.token.cdata{color:var(--comment)}.token.punctuation{color:var(--default)}.namespace{opacity:.7}.token.property,.token.tag,.token.constant,.token.symbol,.token.deleted{color:var(--pink)}.token.boolean,.token.number{color:var(--purple)}.token.selector,.token.string,.token.char,.token.builtin,.token.inserted{color:var(--yellow)}.token.operator,.token.entity,.token.url,.language-css .token.string,.style .token.string,.token.variable{color:var(--default)}.token.atrule,.token.attr-value{color:var(--yellow)}.token.attr-name,.token.function{color:var(--green)}.language-bash .function,.language-shell .function{color:var(--default)}.token.class-name{color:var(--cyan)}.token.regex-flags,.token.keyword{color:var(--pink)}.token.regex-delimiter{color:var(--red)}.token.regex{color:var(--yellow)}.token.parameter,.token.important{color:var(--orange)}.token.important,.token.bold{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}@media (max-width: 600px){code,pre{font-size:.9rem}}
</style><script type="module">const e=document.querySelector("#nav-mobile");e?.addEventListener("click",()=>{e.classList.toggle("nav-mobile-active")});
</script></head> <body> <header class="main-header"> <nav class="nav-container"> <a href="/"><img src="/favicon.svg"></a> <div class="nav-list"> <a href="/" class="nav-link">Home</a> <a href="https://github.com/carlos8v/blog" target="_blank" class="nav-link">Github</a> </div> </nav> <svg id="nav-mobile" class="nav-mobile" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 14"> <path class="nav-icon-top" d="M1 2a1 1 0 0 1 0-2h18a1 1 0 0 1 0 2z"></path> <path class="nav-icon-middle" d="M1 8a1 1 0 0 1 0-2h18a1 1 0 0 1 0 2z"></path> <path class="nav-icon-bottom" d="M1 14a1 1 0 0 1 0-2h18a1 1 0 0 1 0 2z"></path> </svg> <div class="nav-list-mobile"> <a href="/" class="nav-link-mobile">Home</a> <a href="https://github.com/carlos8v/blog" target="_blank" class="nav-link-mobile">Github</a> </div>  </header>  <main class="main-wrapper"> <article class="post-container">  <div class="post-content"> <h1 class="post-title"> Servir websockets com nginx <small>Publicado em: <pub-date data-datetime="Sat Feb 03 2024 00:00:00 GMT+0000 (Coordinated Universal Time)"> <time id="pubDate" datetime="2024-02-03T00:00:00.000Z"></time> </pub-date> <script>
  class PubDate extends HTMLElement {
    constructor() {
      super()

      const pubDate = this.querySelector('#pubDate')

      if (pubDate && this.dataset.datetime) {
        pubDate.innerHTML = new Date(this.dataset.datetime).toLocaleDateString(
          undefined,
          {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          }
        )
      }
    }
  }

  customElements.define('pub-date', PubDate)
</script></small>  </h1> <hr>  <h3 id="configuração-inicial">Configuração inicial</h3>
<p>Exemplo de configuração do site com nginx:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="nginx"><code><span class="line"><span style="color:#6A737D"># Upstream da sua aplicação com endereço ip e porta</span></span>
<span class="line"><span style="color:#F97583">upstream</span><span style="color:#B392F0"> website </span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">  server</span><span style="color:#E1E4E8"> 127.0.0.1:3000;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Configuração padrão do serviço com ssl</span></span>
<span class="line"><span style="color:#F97583">server</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  listen </span><span style="color:#79B8FF">443</span><span style="color:#E1E4E8"> ssl;</span></span>
<span class="line"><span style="color:#F97583">  listen </span><span style="color:#E1E4E8">[::]:443 ssl;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  ssl_certificate </span><span style="color:#E1E4E8">/etc/letsencrypt/live/website.com/fullchain.pem;</span></span>
<span class="line"><span style="color:#F97583">  ssl_certificate_key </span><span style="color:#E1E4E8">/etc/letsencrypt/live/website.com/privkey.pem;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  location</span><span style="color:#B392F0"> / </span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    proxy_pass </span><span style="color:#E1E4E8">http://website;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="configuração-dos-headers-de-requisição">Configuração dos headers de requisição</h3>
<p>É preciso atualizar os headers da aplicação para que o redirecionamento mantenha os dados da requisição e adicione informações do nginx:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#E1E4E8">  ...</span></span>
<span class="line"><span style="color:#E1E4E8">  location / {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>   proxy_set_header Host $host;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>   proxy_set_header X-Real-IP $remote_addr;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>   proxy_set_header X-Forwarded-Proto $scheme;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="habilitar-websocket">Habilitar websocket</h3>
<p>É preciso atualizar os headers na configuração do nginx para que seja possível a atualização da conexão para <em>websockets</em>:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="diff"><code><span class="line"><span style="color:#E1E4E8">    ...</span></span>
<span class="line"><span style="color:#E1E4E8">    location / {</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     proxy_http_version 1.1;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     proxy_set_header Upgrade $http_upgrade;</span></span>
<span class="line"><span style="color:#85E89D"><span style="user-select: none;">+</span>     proxy_set_header Connection "Upgrade";</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span></code></pre>  </div> </article> </main>  </body></html>